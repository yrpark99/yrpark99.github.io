---
title: "Dockerë¡œ GitLab ì„œë²„ ì„¤ì¹˜í•˜ê¸°"
category: [Docker, SCM]
toc: true
toc_label: "ì´ í˜ì´ì§€ ëª©ì°¨"
---

Docker ì»¨í…Œì´ë„ˆë¡œ GitLab ì„œë²„ë¥¼ ì„¤ì¹˜í•˜ê³  ê´€ë ¨ ë‚´ìš©ì„ ì •ë¦¬í•˜ì˜€ë‹¤.

## ì¼ë°˜ì ì¸ GitLab ì„œë²„ ì„¤ì¹˜
ë¨¼ì € ê°„ëµíˆ Ubuntuì—ì„œ ì¼ë°˜ì ì¸ GitLab ì„œë²„ ì„¤ì¹˜ë¥¼ ì•Œì•„ë³´ë©´, ëŒ€ëµ ì•„ë˜ì™€ ê°™ë‹¤.
1. ìš°ë¶„íˆ¬ ì—…ë°ì´íŠ¸ ë° í•„ìš”í•œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•œë‹¤.
```bash
$Â sudo apt-get update
$Â sudo apt-get install -y curl openssh-server ca-certificates
```
1. ì•„ë˜ì™€ ê°™ì´ GitLab íŒ¨í‚¤ì§€ ì €ì¥ì†Œë¥¼ add í•œë‹¤.Â (ì•„ë˜ ì˜ˆì—ì„œëŠ” Community Editionì„ ì„¤ì¹˜í•˜ê¸° ìœ„í•´ `gitlab-ce`ë¥¼ ì‚¬ìš©)
```bash
$Â curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash
```
1. ì•„ë˜ì™€ ê°™ì´ ì„¤ì¹˜í•œë‹¤. (ì•„ë˜ ì˜ˆì—ì„œëŠ” Community Editionì„ ì„¤ì¹˜í•˜ê¸° ìœ„í•´ `gitlab-ce`ë¥¼ ì‚¬ìš©)
```bash
$Â apt-get install gitlab-ce
```
1. URL ì£¼ì†Œë‚˜ í¬íŠ¸ ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ë ¤ë©´ /etc/gitlab/gitlab.rb íŒŒì¼ì—ì„œ "external_url" ì •ë³´ë¥¼ ìˆ˜ì •í•œ í›„, ì•„ë˜ì™€ ê°™ì´ ì ìš©í•´ ì¤€ë‹¤.
```bash
$ sudo gitlab-ctl reconfigure
```
> ìœ„ì˜ step 4 ê³¼ì •ì„ ìƒëµí•˜ë ¤ë©´, step 3ì—ì„œ ì•„ë˜ì™€ ê°™ì´ ì ‘ì†í•  í˜¸ìŠ¤íŠ¸ URLì„ ì§€ì •í•˜ì—¬ ì„¤ì¹˜í•˜ë©´ ëœë‹¤.
```bash
$ sudo EXTERNAL_URL="your_ip_address" apt-get install gitlab-ce
```
1. ì´ì œ ì•„ë˜ì™€ ê°™ì´ GitLab ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘/ì¬ì‹œì‘ì‹œí‚¤ë©´ í•´ë‹¹ URL ì£¼ì†Œì— ì ‘ì†í•  ìˆ˜ ìˆë‹¤.
```bash
$ sudo gitlab-ctl restart
```
1. GitLab ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€ì‹œí‚¤ë ¤ë©´ ì•„ë˜ì™€ ê°™ì´ í•œë‹¤.
```bash
$ sudo gitlab-ctl stop
```

## Dockerë¡œ GitLab ì„œë²„ ì„¤ì¹˜
ê·¸ëŸ°ë° ì˜¤ëœë§Œì— íŒ€ ê°œë°œ ì„œë²„ì— ë‹¤ì‹œ <span style="color:blue">GitLab ì„œë²„</span>ë¥¼ ì„¤ì¹˜í•˜ë ¤ê³  í•˜ë‹ˆ, dependency ë¬¸ì œë¡œ ì œëŒ€ë¡œ ì„¤ì¹˜ê°€ ë˜ì§€ ì•Šì•˜ê³ , í•´ê²°ì´ ì‰½ì§€ ì•Šì€ ìƒí™©ì´ì—ˆë‹¤.  
ê·¸ë˜ì„œ ê°„ë‹¨íˆ Dockerë¡œ ì„¤ì¹˜í•˜ê¸°ë¡œ í•˜ì˜€ê³  (ì „ì—ë„ í…ŒìŠ¤íŠ¸ë¡œ GitLab, Jenkins, SonarQubeë¥¼ Docker composeë¡œ ì„¤ì¹˜í–ˆì—ˆë˜ ì ì´ ìˆì—ˆìŒ) ì—¬ê¸°ì— ì„¤ì¹˜ ì´ë ¥ì„ ë‚¨ê¸´ë‹¤.

Dockerë¡œ GitLab ì„œë²„ë¥¼ ì„¤ì¹˜í•˜ê¸° ìœ„í•´ì„œ [`GitLab Docker images`](https://docs.gitlab.com/omnibus/docker/README.html) í˜ì´ì§€ë¥¼ ì°¸ì¡°í•˜ì—¬, ì•„ë˜ì™€ ê°™ì´ ì„¤ì¹˜í•˜ì˜€ë‹¤.
1. ì•„ë˜ ì˜ˆì™€ ê°™ì´ `docker-compose.yml` íŒŒì¼ì„ ì‘ì„±í•˜ì˜€ë‹¤. (HTTP ì ‘ì†ì„ í—ˆê°€í•˜ì§€ ì•Šê¸° ìœ„í•´ì„œ í¬íŠ¸ `80:80` ë¶€ë¶„ì€ ì˜ë„ì ìœ¼ë¡œ ì œê±°í–ˆìŒ)
```jsx
web:
    image:Â 'gitlab/gitlab-ce:latest'
    restart:Â always
    hostname:Â 'your_ip_address'
    environment:
        GITLAB_OMNIBUS_CONFIG:Â |
            external_urlÂ 'https://your_ip_address'
            nginx['ssl_certificate'] = "/etc/gitlab/ssl/server.crt"
            nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/server.key"
    ports:
        -Â '443:443'
        -Â '2222:22'
    volumes:
        -Â '/srv/gitlab/config:/etc/gitlab'
        -Â '/srv/gitlab/logs:/var/log/gitlab'
        -Â '/srv/gitlab/data:/var/opt/gitlab'
```
1. ìœ„ì˜ Docker compose íŒŒì¼ì—ì„œ ë³´ë“¯ì´ í˜¸ìŠ¤íŠ¸ì˜ `/srv/gitlab/` ê²½ë¡œë¥¼ Docker ë³¼ë¥¨ê³¼ ì—°ê²°í•˜ë¯€ë¡œ, ì´ ê²½ë¡œë¥¼ ìƒì„±í•˜ê³ , HTTPS ì ‘ì†ì„ ìœ„í•´ server ì¸ì¦ì„œë¥¼ ìƒì„±í•œ í›„ ([`HTTPS ìš© ì‚¬ì„¤ ì¸ì¦ì„œ ë§Œë“¤ê¸°`](https://yrpark99.github.io/https/https_ssl/) ì°¸ì¡°), ì´ íŒŒì¼ë“¤ì„ `/srv/gitlab/config/ssl/` ë””ë ‰í† ë¦¬ì— ì €ì¥í•œë‹¤.
1. ì´ì œ ì•„ë˜ì™€ ê°™ì´ ì‹¤í–‰ì‹œí‚¤ë©´ gitlab ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ëœë‹¤. (ì»¨í…Œì´ë„ˆ ì´ë¦„ì€ `gitlab_web_1`)
```bash
$Â docker-compose up -d
```
1. Gitlab ì—…ë°ì´íŠ¸ëŠ” ì•„ë˜ì™€ ê°™ì´ í•  ìˆ˜ ìˆë‹¤.
```bash
$ docker-compose pull
$ docker-compose up -d
```
1. Gitlab ì»¨í…Œì´ë„ˆì˜ config íŒŒì¼ ìˆ˜ì •ì€ ì•„ë˜ ì˜ˆì™€ ê°™ì´ í•  ìˆ˜ ìˆë‹¤. (ì˜ˆ: `external_url` í•­ëª© ë“±)
```bash
$ docker exec -it gitlab_web_1 vi /etc/gitlab/gitlab.rb
```
Config íŒŒì¼ì„ ìˆ˜ì •í•œ í›„ì—ëŠ” ì•„ë˜ì™€ ê°™ì´ í•˜ë©´ ë³€ê²½ëœ ì„¤ì •ì´ ì ìš©ëœë‹¤. (ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì¬ì‹œì‘ì´ í•„ìš”ì—†ìŒ)
```bash
$ docker exec -t gitlab_web_1 gitlab-ctl reconfigure
```
1. í•„ìš”í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì»¨í…Œì´ë„ˆë¥¼ ì¬ì‹œì‘ì‹œí‚¬ ìˆ˜ ìˆë‹¤.
```bash
$ docker restart gitlab_web_1
```

## íŒ
* <span style="color:blue">ë©”ì¼ ë°œì†¡ ê¸°ëŠ¥ ì§€ì›</span>  
[`GitLab SMTP settings`](https://docs.gitlab.com/omnibus/settings/smtp.html#smtp-settings) í˜ì´ì§€ë¥¼Â ì°¸ì¡°í•˜ì—¬ ì•„ë˜ì™€ ê°™ì´ í•˜ì˜€ë‹¤.
```bash
$ docker exec -it gitlab_web_1 vi /etc/gitlab/gitlab.rb
```
ì´í›„ ì•„ë˜ì™€ ê°™ì´ ì„¸íŒ…í•˜ì˜€ë‹¤. (ì•„ë˜ì—ì„œ *your_xxx* ë¶€ë¶„ì€ ë³¸ì¸ ì •ë³´ë¡œ ì„¸íŒ…í•´ì•¼ í•¨)
```ruby
gitlab_rails['smtp_enable']Â =Â true
gitlab_rails['smtp_address']Â =Â "smtp.gmail.com"
gitlab_rails['smtp_port']Â =Â 587
gitlab_rails['smtp_user_name']Â =Â "your_user_name"
gitlab_rails['smtp_password']Â =Â "your_password"
gitlab_rails['smtp_domain']Â =Â "your_domain"
gitlab_rails['smtp_authentication']Â =Â "login"
gitlab_rails['smtp_enable_starttls_auto']Â =Â true
gitlab_rails['smtp_tls']Â =Â false
```
* <span style="color:blue">ê´€ë¦¬ì ì•”í˜¸ ì„¸íŒ…í•˜ê¸°</span>  
GitLab ì„œë²„ì˜ ìµœì´ˆ ê´€ë¦¬ì IDëŠ” `root`, PWëŠ” `5iveL!fe`ì´ë‹¤. ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•œ í›„, ì•”í˜¸ë¥¼ ë³€ê²½í•œë‹¤. ê·¸ëŸ°ë° ë§Œì•½ ê´€ë¦¬ì ì•”í˜¸ë¥¼ ìŠì–´ë²„ë¦° ê²½ìš°ì—ëŠ” ì•„ë˜ì™€ ê°™ì´ ì»¨í…Œì´ë„ˆì˜ ì‰˜ì„ ë„ì›Œì„œ ì•”í˜¸ë¥¼ ì¬ì„¤ì •í•˜ë©´ ëœë‹¤.
```bash
$ docker exec -it gitlab_web_1 /bin/bash
```
ì´í›„ ì»¨í…Œì´ë„ˆì—ì„œ ì•„ë˜ì™€ ê°™ì´ ì‹¤í–‰í•œë‹¤. (ì•„ë˜ì—ì„œ *new_password* ë¶€ë¶„ì— ìƒˆë¡œìš´ ì•”í˜¸ë¥¼ ì„¸íŒ…í•˜ë©´ ë¨)
```bash
root@ca:/# gitlab-rails console -e production
irb(main):001:0> u = User.find_by(username: 'root')
irb(main):002:0> u.password = 'new_password'
irb(main):003:0> u.password_confirmation = 'new_password'
irb(main):004:0> u.save
irb(main):005:0> exit
root@ca:/# exit
```
ì´í›„ ì•„ë˜ì™€ ê°™ì´ ì»¨ë„¤ì´ë„ˆë¥¼ ì¬ì‹œì‘ì‹œí‚¤ë©´ ë°˜ì˜ëœë‹¤.
```bash
$ docker restart gitlab_web_1
```
* <span style="color:blue">HSTS(HTTP Strict Transport Security) ê´€ë ¨</span>  
HSTSë¥¼ ì§€ì›í•˜ëŠ” ì›¹ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì¼ë‹¨ HTTPSë¡œ ì—°ê²°ì´ ëœ ì‚¬ì´íŠ¸ë©´, ì´í›„ë¶€í„°ëŠ” HTTPë¡œ ì ‘ì†í•´ë„ ìë™ìœ¼ë¡œ HTTPSë¡œ redirect ë˜ì–´ ì ‘ì†ëœë‹¤. ë§Œì•½, ì´ ë™ì‘ì„ ì˜ë„ì ìœ¼ë¡œ ë§‰ê³ ì í•œë‹¤ë©´ ì»¨í…Œì´ë„ˆì˜ /etc/gitlab/gitlab.rb íŒŒì¼ì—ì„œ ì•„ë˜ì™€ ê°™ì´ ì„¸íŒ…í•˜ë©´ ëœë‹¤.
```ruby
nginx['hsts_max_age']Â =Â 0
```
* <span style="color:blue">PlantUML ì§€ì›í•˜ê¸°</span>  
GitLabì—ì„œ PlantUMLì„ enable ì‹œí‚¤ë ¤ë©´ rootë¡œ ë¡œê·¸ì¸í•œ í›„, Admin Area -> Settings -> Integrations -> PlantUML -> "Enable PlantUML" í•­ëª©ì„ í™œì„±í™”í•˜ê³ , **"PlantUML URL"** í•­ëª©ì— PlantUML ì„œë²„ ì£¼ì†Œë¥¼ ì„¸íŒ…í•˜ë©´ ëœë‹¤.  
(Local ì„œë²„ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì£¼ì†Œë¥¼, ì—†ìœ¼ë©´ PlantUML online demo server ì£¼ì†Œì¸ `http://www.plantuml.com/plantuml/`ë¥¼ ì…ë ¥í•˜ë©´ ëœë‹¤.)
ë‚˜ëŠ” PlantUML ë‚´ìš©ì´ ì™¸ë¶€ì— open ë˜ì§€ ì•Šë„ë¡ local ì„œë²„ë¥¼ Dockerë¡œ ìš´ìš©í•˜ê¸°ë¡œ í•˜ì˜€ê³ , ì´ë¥¼ ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ ì‹¤í–‰ì‹œì¼°ë‹¤.
```bash
$ docker run -d --name plantuml --restart=always -p 8080:8080 plantuml/plantuml-server:tomcat
```
PlantUML ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ë©´, http://localhost:8080 ì£¼ì†Œì— ì ‘ì†í•´ ë³´ë©´ PlantUML server í™”ë©´ì´ í‘œì‹œë¨ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. **"PlantUML URL"** í•­ëª©ì— local PlantUML ì„œë²„ ì£¼ì†Œë¥¼ ì„¸íŒ…í•œë‹¤.  
Markdown íŒŒì¼ì—ì„œëŠ” ì•„ë˜ ì˜ˆì™€ ê°™ì´ í•˜ë©´, ì´ì˜ê²Œ PlantUMLë¡œ ë Œë”ë§ë˜ì–´ ì¶œë ¥ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.ğŸ¥‚  
(ì°¸ê³ ë¡œ ì•„ë˜ì—ì„œ GitLabì—ì„œëŠ” `@startuml`, `@enduml` ë¶€ë¶„ì´ ì—†ì–´ë„ í‘œì‹œê°€ ì •ìƒì ìœ¼ë¡œ ë˜ì§€ë§Œ, VS Codeì—ì„œ previewê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë˜ë ¤ë©´ ì´ ë¶€ë¶„ì´ í•„ìš”í•˜ì—¬ ë„£ì—ˆìŒ)
~~~jsx
```plantuml
@startuml
BobÂ ->Â AliceÂ :Â hello
@enduml
```
~~~