---
title: "X.509 ì¸ì¦ì„œ íŒŒì‹±í•˜ê¸°"
category: [C/C++]
toc: true
toc_label: "ì´ í˜ì´ì§€ ëª©ì°¨"
---

X.509 ì¸ì¦ì„œì˜ íŒŒì‹± ë°©ë²•ê³¼ C ì–¸ì–´ë¡œ êµ¬í˜„í•œ ì˜ˆì œì´ë‹¤.

<br>
PKI(Public Key Infrastructure)ì—ì„œ ì‚¬ìš©ë˜ëŠ” X.509 ì¸ì¦ì„œëŠ” `ASN.1`(Abstract Syntax Notation One) í‘œê¸°ë²•ìœ¼ë¡œ ì‘ì„±ë˜ì–´ ìˆë‹¤. ASN.1ì€ í¬ë¡œìŠ¤ í”Œë«í¼ ê°„ì—ë„ ë°ì´í„°ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì „ì†¡í•  ìˆ˜ ìˆëŠ” ë°ì´í„° êµ¬ì¡°ë¥¼ ì •ì˜í•œ í˜•ì‹ì´ë‹¤.  
ì´ë²ˆ ê¸€ì—ì„œëŠ” X.509 ì¸ì¦ì„œì˜ (ASN.1 í˜•ì‹ìœ¼ë¡œ êµ¬ì„±ë¨) êµ¬ì¡°ì™€ ì´ë¥¼ íŒŒì‹±í•˜ì—¬ ì›í•˜ëŠ” í•­ëª©ì„ ì–»ëŠ” ê°„ë‹¨í•œ C ì˜ˆì œë¥¼ êµ¬í˜„í•´ ë³¸ë‹¤.

## ASN.1 ì°¸ê³  ìë£Œ
  - [ASN.1 Universal Tag](https://www.obj-sys.com/asn1tutorial/node124.html)
  - [A Layman's Guide to a Subset of ASN.1, BER, and DER](http://luca.ntop.org/Teaching/Appunti/asn1.html)

## ASN.1 ê¸¸ì´
ASN.1 ê¸¸ì´ í‘œê¸°ë²•ì€ ë‹¤ìŒ í‘œì™€ ê°™ì´ ìš”ì•½í•  ìˆ˜ ìˆë‹¤.

<table>
  <thead>
    <tr>
      <th style="text-align: center">ê¸¸ì´</th>
      <th style="text-align: center">1st byte</th>
      <th style="text-align: center">2nd byte</th>
      <th style="text-align: center">3rd byte</th>
      <th style="text-align: center">4th byte</th>
      <th style="text-align: center">5th byte</th>
      <th style="text-align: center">ê°’ì˜ ë²”ìœ„</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">1byte</td>
      <td style="text-align: center">0x00 ~ 0x7F</td>
      <td style="text-align: center" colspan="4">-</td>
      <td style="text-align: center">0x00 ~ 0x7F</td>
    </tr>
    <tr>
      <td style="text-align: center">2bytes</td>
      <td style="text-align: center">0x81</td>
      <td style="text-align: center">0x00 ~ 0xFF</td>
      <td style="text-align: center" colspan="3">-</td>
      <td style="text-align: center">0x00 ~ 0xFF</td>
    </tr>
    <tr>
      <td style="text-align: center">3bytes</td>
      <td style="text-align: center">0x82</td>
      <td style="text-align: center" colspan="2">0x0000 ~ 0xFFFF</td>
      <td style="text-align: center" colspan="2">-</td>
      <td style="text-align: center">0x0000 ~ 0xFFFF</td>
    </tr>
    <tr>
      <td style="text-align: center">4bytes</td>
      <td style="text-align: center">0x83</td>
      <td style="text-align: center" colspan="3">0x000000 ~ 0xFFFFFF</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">0x000000 ~ 0xFFFFFF</td>
    </tr>
    <tr>
      <td style="text-align: center">5bytes</td>
      <td style="text-align: center">0x84</td>
      <td style="text-align: center" colspan="4">0x00000000 ~ 0xFFFFFFFF</td>
      <td style="text-align: center">0x00000000 ~ 0xFFFFFFFF</td>
    </tr>
  </tbody>
</table>

## Toolì„ ì‚¬ìš©í•´ì„œ ASN.1 íŒŒì‹±í•˜ê¸°

### Online íˆ´
  - [ASN.1 JavaScript decoder](https://lapo.it/asn1js/)

### Windowsì—ì„œ ASN.1 íŒŒì‹±
Windowsì—ì„œëŠ” ê¸°ë³¸ìœ¼ë¡œ ì„¤ì¹˜ëœ `certutil` íˆ´ì„ ì´ìš©í•  ìˆ˜ ìˆë‹¤.
ì•„ë˜ì™€ ê°™ì´ ì‹¤í–‰í•˜ë©´ ì…ë ¥ íŒŒì¼ì„ ASN.1 í˜•ì‹ìœ¼ë¡œ íŒŒì‹± í•´ì„œ ì¶œë ¥í•´ ì¤€ë‹¤.
```batch
C:\>certutil -asn <ì…ë ¥ íŒŒì¼>
```
ë§Œì•½ì— ì…ë ¥ íŒŒì¼ì´ X.509 ì¸ì¦ì„œì¸ ê²½ìš°ì—ëŠ” ì•„ë˜ì™€ ê°™ì´ ì‹¤í–‰í•˜ë©´ ì¸ì¦ì„œë¡œ íŒŒì‹±í•´ ì¤€ë‹¤. (ì‚¬ì‹¤ìƒ ì¸ì¦ì„œ íŒŒì¼ì„ ë”ë¸” í´ë¦­í•˜ë©´ í‘œì‹œë˜ëŠ” ì¸ì¦ì„œ íŒì—… ë‚´ìš©ê³¼ ë™ì¼í•¨)
```batch
C:\>certutil -dump <ì…ë ¥ íŒŒì¼>
```

### Linuxì—ì„œ ASN.1 íŒŒì‹±
Linuxì—ì„œëŠ” `OpenSSL` íˆ´ì—ì„œ <font color=blue>asn1parse</font> ëª…ë ¹ì„ ì´ìš©í•  ìˆ˜ ìˆë‹¤. ì•„ë˜ì™€ ê°™ì´ ì‹¤í–‰í•˜ë©´ ë„ì›€ë§ì´ ì¶œë ¥ëœë‹¤.
```sh
$ openssl help asn1parse
```
ì•„ë˜ ì˜ˆì™€ ê°™ì´ ì‹¤í–‰í•˜ë©´ ì…ë ¥ íŒŒì¼ì„ ASN.1 í˜•ì‹ìœ¼ë¡œ íŒŒì‹± í•´ì„œ ì¶œë ¥í•´ ì¤€ë‹¤.
```sh
$ openssl asn1parse -inform DER -in <ì…ë ¥ íŒŒì¼>
```

## OpenSSLì„ ì´ìš©í•œ X.509 ì¸ì¦ì„œ íŒŒì‹±
OpenSSLì„ ì´ìš©í•´ì„œ X.509 ì¸ì¦ì„œë¥¼ íŒŒì‹±í•˜ëŠ” ê²ƒì€ OpenSSLì„ ê·¸ëŒ€ë¡œ ì´ìš©í•˜ë©´ ë˜ë¯€ë¡œ ê°„ë‹¨í•˜ë‹¤. ì´ëŸ° ê²½ìš°ë¼ë©´ [Parsing X.509 Certificates with OpenSSL and C](https://zakird.com/2013/10/13/certificate-parsing-with-openssl) ë“±ì„ ì°¸ê³ í•˜ë©´ ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

## OBJECT_ID ì¸ì½”ë”©
ASN.1ì—ì„œëŠ” ì˜¤ë¸Œì íŠ¸ë¥¼ êµ¬ë¶„í•˜ê¸° ìœ„í•˜ì—¬ `OBJECT_ID`ê°€ ì‚¬ìš©ë˜ëŠ”ë° (ê° IDë“¤ì€ ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆìŒ), ì´ ê°’ì€ ê¸¸ì´ê°€ ê°€ë³€ì´ê³  ASN.1ì— ëª…ì‹œëœ ê°€ë³€ ê¸¸ì´ í‘œê¸°ë²•ì„ ë”°ë¼ì„œ ì¸ì½”ë”© ëœë‹¤.  
ì¦‰, OBJECT_ID í•„ë“œëŠ” **x.x.x.x.x...** ì™€ ê°™ì€ ì—¬ëŸ¬ ê°œì˜ ë…¸ë“œë¡œ êµ¬ì„±ë˜ì–´ ìˆìœ¼ë©° ì•„ë˜ì™€ ê°™ì€ ê·œì¹™ìœ¼ë¡œ ì¸ì½”ë”© ëœë‹¤.
- 1ë²ˆì§¸, 2ë²ˆì§¸ node ê°’ì€ (1ë²ˆì§¸ node * 40 + 2ë²ˆì§¸ node)ì˜ 1ë°”ì´íŠ¸ë¡œ ì¸ì½”ë”© ë¨
- node ê°’ì´ 127 ì´í•˜ì¸ ê²½ìš°ì—ëŠ” ê·¸ëŒ€ë¡œ 1ë°”ì´íŠ¸ ê°’ìœ¼ë¡œ ì¸ì½”ë”© ë¨
- node ê°’ì´ 128 ì´ìƒì¸ ê²½ìš°ì—ëŠ” ASN.1 í¬ë§·ì— ë”°ë¼ ë‹¤ìˆ˜ì˜ ë°”ì´íŠ¸ë¡œ ì¸ì½”ë”© ë¨

ì•„ë˜ì— ì˜ˆë¥¼ ë“¤ì–´ë³¸ë‹¤.
1. OBJECT_ID = **2.5.4.3** ì¸ ê²½ìš°  
1ë²ˆì§¸ node, 2ë²ˆì§¸ node: 2*40 + 5 = 0x55  
3ë²ˆì§¸ node: 4 => 0x04  
4ë²ˆì§¸ node: 3 => 0x03  
=> ìµœì¢… ì¸ì½”ë”© ê²°ê³¼: **0x55 0x04 0x03**
1. OBJECT_ID = **1.3.6.1.4.1.311.21.20** ì¸ ê²½ìš°  
1ë²ˆì§¸ node, 2ë²ˆì§¸ node: 1*40 + 3 = 43 = 0x2B  
3ë²ˆì§¸ node: 6 => 0x06  
4ë²ˆì§¸ node: 1 => 0x01  
5ë²ˆì§¸ node: 4 => 0x04  
6ë²ˆì§¸ node: 1 => 0x01  
7ë²ˆì§¸ node: 311 = 0x137 => 0x82 0x37  
8ë²ˆì§¸ node: 21 => 0x15  
9ë²ˆì§¸ node: 20 => 0x14  
=> ìµœì¢… ì¸ì½”ë”© ê²°ê³¼: **0x2B 0x06 0x01 0x04 0x01 0x82 0x37 0x15 0x14**
1. OBJECT_ID = **1.0.8571.2.1** ì¸ ê²½ìš°  
1ë²ˆì§¸ node, 2ë²ˆì§¸ node: 1*40 + 0 = 40 = 0x28  
3ë²ˆì§¸ node 8571 = 0x217B => 0xC2 0x7B  
4ë²ˆì§¸ node 2 => 0x02  
5ë²ˆì§¸ node 1 => 0x01  
=> ìµœì¢… ì¸ì½”ë”© ê²°ê³¼: **0x28 0xC2 0x7B 0x02 0x01**

## X.509 ì¸ì¦ì„œ í˜•ì‹
1. X.509 v3ì˜ ë””ì§€í„¸ ì¸ì¦ì„œëŠ” ASN.1 í˜•ì‹ìœ¼ë¡œ ì•„ë˜ êµ¬ì¡°ë¡œ êµ¬ì„±ëœë‹¤.
   - Version: ì¸ì¦ì„œì˜ ë²„ì „ì„ ë‚˜íƒ€ëƒ„
   - Serial Number: CAê°€ í• ë‹¹í•œ ì •ìˆ˜ë¡œ ëœ ê³ ìœ  ë²ˆí˜¸
   - Signature: ì„œëª… ì•Œê³ ë¦¬ì¦˜ ì‹ë³„ì
   - Issuer: ë°œí–‰ì
   - Validity: ìœ íš¨ê¸°ê°„
     - Not Before: ìœ íš¨ê¸°ê°„ ì‹œì‘ ë‚ ì§œ
     - Not After: ìœ íš¨ê¸°ê°„ ëë‚˜ëŠ” ë‚ ì§œ
   - Subject: ì†Œìœ ì
   - Subject Public Key Info: ì†Œìœ ì ê³µê°œ í‚¤ ì •ë³´
   - Public Key Algorithm: ê³µê°œ í‚¤ ì•Œê³ ë¦¬ì¦˜
   - Subject Public Key: ì†Œìœ ìì˜ ê³µê°œ í‚¤
   - Issuer Unique Identifier: (Optional) ë°œí–‰ì ê³ ìœ  ì‹ë³„ì
   - Subject Unique Identifier: (Optional) ì†Œìœ ì ê³ ìœ  ì‹ë³„ì
   - Extensions: (Optional) í™•ì¥

   ìœ„ ë‚´ìš©ì„ Extensionì„ ì œì™¸í•œ í•„ìˆ˜ ì •ë³´ë§Œ í‘œë¡œ ë‹¤ì‹œ ë‚˜íƒ€ë‚´ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

   |í•­ëª©ëª…|ì„¤ëª…|
   |:---:|:---:|
   |Version|ì¸ì¦ì„œì˜ ë²„ì „|
   |SerialNumber|ì¸ì¦ì„œ ê³ ìœ ì˜ ì¼ë ¨ ë²ˆí˜¸|
   |Signature|ë°œê¸‰ìì˜ ì„œëª…|
   |Issuer|ë°œê¸‰ìì˜ ì •ë³´. DN(distinguished name) í˜•ì‹|
   |Validity|ì¸ì¦ì„œì˜ ìœ íš¨ ê¸°ê°„ (ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œ)|
   |Subject|ì£¼ì²´ì˜ ì •ë³´. DN(distinguished name) í˜•ì‹|
   |SubjectPublicKeyInfo|ì£¼ì²´ì˜ ê³µê°œí‚¤|
1. ìœ„ì—ì„œ Issuer(ë°œê¸‰ì)ì™€ Subject(ì£¼ì²´)ì˜ <mark style='background-color: #dcffe4'>DN(distinguished name)</mark> í˜•ì‹ì€ ì•„ë˜ì™€ ê°™ë‹¤.

   |í•­ëª©ëª…|ì„¤ëª…|DN í•­ëª© ì´ë¦„|
   |:---:|:---:|:---:|
   countryName|2ìë¦¬ êµ­ê°€ ì½”ë“œ|C|
   stateOrProvinceName|ì£¼(ë„) ì´ë¦„|ST|
   localityName|ì‹œ ì´ë¦„|L|
   organizationName|ì†Œì† ê¸°ê´€ëª…|O|
   organizationalUnitName|ì†Œì† ë¶€ì„œëª…|OU|
   commonName|ì£¼ì²´ë¥¼ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆëŠ” ì´ë¦„|CN|
   emailAddress|ì´ë©”ì¼ ì£¼ì†Œ|emailAddress|

> ì•„ë˜ C êµ¬í˜„ ì˜ˆì—ì„œëŠ” X.509 ì¸ì¦ì„œì—ì„œ ì£¼ì²´(subject)ì˜ commonNameì„ ì¶”ì¶œì„ í•´ ë³¼í…ë°, ìœ„ì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´ ì´ ì •ë³´ëŠ” Subjectì˜ **commonName**ì´ë‹¤.  
ë”°ë¼ì„œ commonNameì˜ OBJECT_IDëŠ” **2.5.4.3**ì´ë¯€ë¡œ, **2ë²ˆì§¸** OBJECT_ID ê°’ì´ **2.5.4.3**ì¸ í•­ëª©ì„ ì°¾ì•„ì„œ, ì´ì–´ì§€ëŠ” PRINTABLE_STRING ë¬¸ìì—´ì„ ì–»ìœ¼ë©´ ëœë‹¤.

## Cë¡œ íŒŒì‹± êµ¬í˜„ ì˜ˆ
ì•„ë˜ëŠ” X.509 ì¸ì¦ì„œì—ì„œ subjectì˜ commonNameë¥¼ ì¶”ì¶œí•´ì„œ ì¶œë ¥í•˜ëŠ” ë‚´ê°€ ì‘ì„±í•œ ì˜ˆì œ ì½”ë“œì´ë‹¤. ì½”ë“œì— ê°„ë‹¨íˆ ì£¼ì„ì„ ë‹¬ì•˜ìœ¼ë¯€ë¡œ, ìì„¸í•œ ì½”ë“œ ì„¤ëª…ê³¼ ì „ì²´ ì½”ë“œëŠ” ìƒëµí•œë‹¤.
```c
/* ASN.1 íƒ€ì… ì •ì˜ */
typedef enum
{
    ASN1_TYPE_RESERVED = 0x00,
    ASN1_TYPE_BOOLEAN = 0x01,
    ASN1_TYPE_INTEGER = 0x02,
    ASN1_TYPE_BIT_STRING = 0x03,
    ASN1_TYPE_OCTET_STRING = 0x04,
    ASN1_TYPE_NULL = 0x05,
    ASN1_TYPE_OBJECT_IDENTIFIER = 0x06,
    ASN1_TYPE_OBJECT_DESCRIPTOR = 0x07,
    ASN1_TYPE_INSTANCE_OF = 0x08,
    ASN1_TYPE_REAL = 0x09,
    ASN1_TYPE_ENUMERATED = 0x0A,
    ASN1_TYPE_EMBEDDED_PDV = 0x0B,
    ASN1_TYPE_UTF8_STRING = 0x0C,
    ASN1_TYPE_RELATIVE = 0x0D,
    ASN1_TYPE_SEQUENCE_SEQUENCE_OF = 0x10,
    ASN1_TYPE_SET_SET_OF = 0x11,
    ASN1_TYPE_NUMERIC_STRING = 0x12,
    ASN1_TYPE_PRINTABLE_STRING = 0x13,
    ASN1_TYPE_TELETEX_STRING = 0x14,
    ASN1_TYPE_VIDEOTEX_STRING = 0x15,
    ASN1_TYPE_IA5STRING = 0x16,
    ASN1_TYPE_UTC_TIME = 0x17,
    ASN1_TYPE_GENERALIZED_TIME = 0x18,
    ASN1_TYPE_GRAPHIC_STRING = 0x19,
    ASN1_TYPE_VISIBLE_STRING = 0x1A,
    ASN1_TYPE_GENERAL_STRING = 0x1B,
    ASN1_TYPE_UNIVERSAL_STRING = 0x1C,
    ASN1_TYPE_CHARACTER_STRING = 0x1D,
    ASN1_TYPE_BMP_STRING = 0x1E
} ASN_1_TYPE_E;

/* ì…ë ¥ ASN.1 ê¸¸ì´ë¥¼ ì–»ê³ , ê¸¸ì´ í•„ë“œì˜ ê¸¸ì´ë¥¼ ë¦¬í„´í•œë‹¤. */
unsigned int get_asn1_length(const void *buf, unsigned int *length)
{
    unsigned char *p = (unsigned char *)buf;
    unsigned char firstByte = *p++;

    if (firstByte >= 0x00 && firstByte <= 0x7F)
    {
        *length = firstByte;
        return 1;
    }
    else if (firstByte == 0x81)
    {
        *length = p[0];
        return 2;
    }
    else if (firstByte == 0x82)
    {
        *length = (unsigned short)(p[0] << 8) | p[1];
        return 3;
    }
    else if (firstByte == 0x83)
    {
        *length = (unsigned int)(p[0] << 16) | (p[1] << 8) | p[2];
        return 4;
    }

    *length = 0;
    return 0;
}

void print_common_name(unsigned char *certData, unsigned int certLen)
{
    unsigned char tag;
    unsigned char commonName_objectId[] = {0x55, 0x04, 0x03}; // CommonName OBJECT_ID = 2.5.4.3
    unsigned int length_field_len, length, i;
    bool constructed;
    unsigned int commonName_objectId_counter = 0;
    unsigned char *subjectCommonName;

    i = 0;
    while (i < certLen)
    {
        tag = certData[i];
        if (tag & 0x20)
        {
            constructed = true; // constructed
        }
        else
        {
            constructed = false; // primitive
        }
        tag &= 0x1F;
        i++;

        length_field_len = get_asn1_length(certData + i, &length);
        i += length_field_len;

        /* Constructed ì´ë©´ ë‹¤ìŒ TLVë¥¼ ì½ëŠ”ë‹¤. */
        if (constructed == true)
        {
            continue;
        }

        /* CommonName OBJECT_ID ì´ë©´, ë‹¤ìŒ PRINTABLE_STRING ì •ë³´ë¥¼ ì–»ëŠ”ë‹¤. */
        if (tag == ASN1_TYPE_OBJECT_IDENTIFIER && length == sizeof(commonName_objectId))
        {
            if (memcmp(certData + i, commonName_objectId, sizeof(commonName_objectId)) == 0)
            {
                commonName_objectId_counter++; // 1st = for Issuer, 2nd = for Subject
            }
        }
        else if (tag == ASN1_TYPE_PRINTABLE_STRING)
        {
            if (commonName_objectId_counter == 2) // 2nd = for Subject
            {
                subjectCommonName = malloc(length);
                memcpy(subjectCommonName, certData + i, length);
                subjectCommonName[length] = '\0';
                printf("Subject commonName: %s\n", subjectCommonName);
                break;
            }
        }
        i += length; // ë‹¤ìŒ TLVë¥¼ ì½ìŒ
    }
}
```

## ë§ºìŒë§
ì‚¬ì‹¤ ë‚˜ëŠ” X.509 ì¸ì¦ì„œê°€ ASN.1 í˜•ì‹ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŒì€ ì˜ˆì „ì— PKIë¥¼ ê³µë¶€í•˜ë©´ì„œ ì•Œê³  ìˆì—ˆëŠ”ë°, ìµœê·¼ì— íšŒì‚¬ ì½”ë“œì—ì„œ X.509 ì¸ì¦ì„œì—ì„œ íŒŒì‹±ì„ ì œëŒ€ë¡œ í•˜ì§€ ì•Šê³  ë©‹ëŒ€ë¡œ ê³ ì • ìœ„ì¹˜ì—ì„œ ì •ë³´ë¥¼ ì½ì–´ì˜¤ëŠ” C ì½”ë“œë¥¼ ë³„ê²¬í•˜ì—¬ì„œ (ì‹¬ì§€ì–´ ì´ê²Œ ìƒìš© ì œí’ˆì˜ ì½”ë“œì˜€ìŒ ğŸ˜°), ì´ë¥¼ ì˜¬ë°”ë¥´ê²Œ íŒŒì‹±í•˜ì—¬ ì–»ëŠ” ë°©ë²•ìœ¼ë¡œ ë°”ë¡œ ì¡ìœ¼ë©´ì„œ ë¸”ë¡œê·¸ì— ì •ë¦¬ê¹Œì§€ í•´ ë³´ì•˜ë‹¤.
