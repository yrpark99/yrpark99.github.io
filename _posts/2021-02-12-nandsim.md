---
title: "NAND simulator"
category: nand
toc: true
toc_label: "ì´ í˜ì´ì§€ ëª©ì°¨"
---

NAND simulator ì‚¬ìš©ë²•ì„ ê°„ë‹¨íˆ ì •ë¦¬í•´ ë³´ì•˜ë‹¤.

## NAND simulator ì†Œê°œ
NAND simulatorëŠ” ì‹œìŠ¤í…œì˜ RAMì„ ì‚¬ìš©í•˜ì—¬ NAND chipì„ ì‹œë®¬ë ˆì´ì…˜í•˜ëŠ” íˆ´ì´ë‹¤. íŠ¹íˆ bad block, bit flip ë“±ì„ ì‹œë®¬ë ˆì´ì…˜í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì‹¤ì œ NAND FLASHë¡œ í…ŒìŠ¤íŠ¸í•˜ê¸° ì–´ë ¤ìš´ ê²ƒë„ ì‰½ê²Œ í…ŒìŠ¤íŠ¸ í•  ìˆ˜ ìˆë„ë¡ í•´ ì£¼ê³ , ì‹¤ì œ embedded ë³´ë“œ ì—†ì´ë„ hostì—ì„œ ê²€ì¦í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.  
ë¬¼ë¡  RAMìœ¼ë¡œ NAND ë™ì‘ì„ ì‹œë®¬ë ˆì´ì…˜í•˜ëŠ” ê²ƒì´ë¯€ë¡œ ë™ì‘ì— ëŒ€í•œ ì‹œë®¬ë ˆì´ì…˜ë§Œ ê°€ëŠ¥í•˜ê³ , ì‹œê°„ì´ë‚˜ ì„±ëŠ¥ ì¸¡ì •ì€ ì•ˆëœë‹¤.  
<br>
Linux Kernelì—ëŠ” `nandsim`ì´ë¼ëŠ” NAND simulatorê°€ ë‚´ì¥ë˜ì–´ ìˆëŠ”ë°, ì†ŒìŠ¤ ì½”ë“œëŠ” `drivers/mtd/nand/nandsim.c` íŒŒì¼ì´ê³ , `CONFIG_MTD_NAND_NANDSIM` (Device Drivers -> Memory Technology Device (MTD) support -> Raw/Parallel NAND Device Support -> Support for NAND Flash Simulator) ì„¤ì •ì„ ëª¨ë“ˆë¡œ enableí•˜ë©´ ëœë‹¤. (ì°¸ê³ ë¡œ ECC modeëŠ” "NAND_ECC_SOFT_BCH"ë¡œ ì„¸íŒ…ë¨)  
<br>
íš¨ìš©ì„±ì— ë¹„í•˜ì—¬ embedded ê°œë°œìì—ê²Œ ìˆì–´ì„œ ì˜ ì•Œë ¤ì ¸ ìˆì§€ ì•Šì•„ì„œ ì •ë¦¬í•˜ë‹¤ë³´ë‹ˆ ì¡°ê¸ˆ ê¸´ ê¸€ì´ ë˜ì—ˆë‹¤. ğŸ˜…

## ì‚¬ì „ ì¤€ë¹„
1. Kernelì´ `CONFIG_MTD_NAND_NANDSIM` ì„¤ì •ì´ enable ë˜ì–´ ë¹Œë“œë˜ì–´ ìˆì–´ì•¼ í•œë‹¤. ì¼ë‹¨ ì•„ë˜ì™€ ê°™ì´ ì‹¤í–‰ì‹œ ì—ëŸ¬ê°€ ì¶œë ¥ë˜ì§€ ì•Šìœ¼ë©´ ëœë‹¤. (ë‹¨, ì´ ê²½ìš° ID ê°’ì´ ì£¼ì–´ì§€ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ 128MiB í¬ê¸°ì˜ ë””í´íŠ¸ NAND ë””ë°”ì´ìŠ¤ë¡œ ìƒì„±ë¨)
```sh
$ sudo modprobe nandsim
```
ì°¸ê³ ë¡œ WSL2 ì‚¬ìš©ì‹œì—ëŠ” ì´ ì„¤ì •ì´ enable ë˜ì–´ ìˆì§€ ì•Šë‹¤. ì´ ê²½ìš° [`WSL2 ê´€ë ¨ ì •ë¦¬`](https://yrpark99.github.io/linux/wsl/) ì°¸ì¡°í•˜ì—¬ Kernelì„ ë¹Œë“œ í›„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.
1. ì•„ë˜ì™€ ê°™ì´ mtd-utils íŒ¨í‚¤ì§€ë¥¼ (NAND ë””ë°”ì´ìŠ¤ ê´€ë ¨ íˆ´) ì„¤ì¹˜í•œë‹¤.
```sh
$ sudo apt install mtd-utils
```

## NAND ë””ë°”ì´ìŠ¤ ìƒì„±
1. `dmesg` ë‚´ìš©ì„ ì‰½ê²Œ í™•ì¸í•˜ê¸° ìœ„í•˜ì—¬ ì•„ë˜ì™€ ê°™ì´ ê¸°ì¡´ ë‚´ìš©ì€ clear ì‹œí‚¨ë‹¤.
   ```sh
   $ sudo dmesg -c
   ```
1. ì‹œë®¬ë ˆì´ì…˜í•˜ë ¤ëŠ” NAND chipì˜ IDë¥¼ ì–»ëŠ”ë‹¤. ("Read ID"(0x90) ëª…ë ¹ìœ¼ë¡œ ì–»ì€ ID ê°’ìœ¼ë¡œ deice IDë¡œ ì‹œì‘í•˜ëŠ” ìµœëŒ€ 5ë°”ì´íŠ¸ ID ê°’ì„, NAND chip data sheetì— ë‚˜ì™€ ìˆìŒ)
1. ì´ì œ ì•„ë˜ ì˜ˆì™€ ê°™ì´ ID ê°’ì„ ì£¼ì–´ì„œ simulated NAND deviceë¥¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤.
   * MT29F2G08AAC (DEVICE ID=0x2CDA9095) ì˜ˆ
     ```sh
     $ sudo modprobe nandsim first_id_byte=0x2C second_id_byte=0xDA third_id_byte=0x90 fourth_id_byte=0x95
     ```
   * ë˜ëŠ” ID ê°’ì„ ì•„ë˜ ì˜ˆì™€ ê°™ì´ `id_byte` ì˜µì…˜ìœ¼ë¡œ ì—°ì´ì–´ ì¤„ ìˆ˜ë„ ìˆë‹¤. 
     ```sh
     $ sudo modprobe nandsim id_bytes=0x2C,0xDA,0x90,0x95
     ```
   * S/W BCH ì„¤ì •ì€ ì•„ë˜ ì˜ˆì™€ ê°™ì´ `bch` ì˜µì…˜ìœ¼ë¡œ ì„¸íŒ…í•  ìˆ˜ ìˆë‹¤. (ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ dmesgë¡œ ì—ëŸ¬ ë‚´ìš© ì°¾ì•„ë³¼ ê²ƒ)
     ```sh
     $ sudo modprobe nandsim id_bytes=0x2C,0xDA,0x90,0x95 bch=4
     ```
1. NAND device ìƒì„±ì‹œ ì—ëŸ¬ê°€ ì¶œë ¥ë˜ì§€ ì•Šì•˜ìœ¼ë©´, NAND deviceê°€ ì œëŒ€ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ ì•„ë˜ ì˜ˆì™€ ê°™ì´ `dmesg` ëª…ë ¹ìœ¼ë¡œ í™•ì¸í•´ë³¸ë‹¤.
   ```sh
   $ dmesg
   nand: device found, Manufacturer ID: 0x2c, Chip ID: 0xda
   nand: Micron NAND 256MiB 3,3V 8-bit
   nand: 256 MiB, SLC, erase size: 128 KiB, page size: 2048, OOB size: 64
   flash size: 256 MiB
   page size: 2048 bytes
   OOB area size: 64 bytes
   sector size: 128 KiB
   pages number: 131072
   pages per sector: 64
   bus width: 8
   bits in sector size: 17
   bits in page size: 11
   bits in OOB size: 6
   flash size with OOB: 270336 KiB
   page address bytes: 5
   sector address bytes: 3
   options: 0x8
   Scanning device for bad blocks
   Creating 1 MTD partitions on "NAND 256MiB 3,3V 8-bit":
   0x000000000000-0x000010000000 : "NAND simulator partition 0"
   ```
1. NAND deviceê°€ ì œëŒ€ë¡œ ìƒì„±ë˜ì—ˆìœ¼ë©´ ì´ì œ ì•„ë˜ì™€ ê°™ì´ `/proc/mtd` ëª©ë¡ì— ë‚˜íƒ€ë‚  ê²ƒì´ë‹¤.
   ```sh
   $ cat /proc/mtd
   dev:Â Â Â Â sizeÂ Â Â erasesizeÂ Â name
   mtd0: 10000000 00020000 "NAND simulator partition 0"
   ```
1. ë˜, ì•„ë˜ ì˜ˆì™€ ê°™ì´ ì´ NAND deviceì˜ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.    
   ```sh
   $ mtdinfo /dev/mtd0
   mtd0
   Name:                           NAND simulator partition 0
   Type:                           nand
   Eraseblock size:                131072 bytes, 128.0 KiB
   Amount of eraseblocks:          2048 (268435456 bytes, 256.0 MiB)
   Minimum input/output unit size: 2048 bytes
   Sub-page size:                  512 bytes
   OOB size:                       64 bytes
   Character device major/minor:   90:0
   Bad blocks are allowed:         true
   Device is writable:             true
   ```

## NAND ë””ë°”ì´ìŠ¤ ê¸°ë³¸ í…ŒìŠ¤íŠ¸
1. ì•„ë˜ì™€ ê°™ì´ MTD íŒŒí‹°ì…˜ì„ erase í•  ìˆ˜ ìˆë‹¤.
   ```sh
   $ sudo flash_erase /dev/mtd0 0 0
   ```
1. ì•„ë˜ ì˜ˆì™€ ê°™ì´ MTD íŒŒí‹°ì…˜ì— ë°ì´í„°ë¥¼ write í•  ìˆ˜ ìˆë‹¤.
   ```sh
   $ dd if=/dev/urandom of=test.bin bs=128k count=10
   $ sudo nandwrite -m -p /dev/mtd0 test.bin
   ```
1. ì•„ë˜ì™€ ê°™ì´ MTD íŒŒí‹°ì…˜ì˜ ë°ì´í„°ë¥¼ ë¤í”„ëœ° ìˆ˜ ìˆë‹¤. (length ì˜µì…˜ì„ ì£¼ì§€ ì•Šìœ¼ë©´ MTD í¬ê¸°ë§Œí¼ ë¤í”„ë¨)
   ```sh
   $ sudo nanddump -f test.read.bin /dev/mtd0 -l 1310720
   ```
   ì½ì€ ë°ì´í„°ê°€ ì›ë³¸ ë°ì´í„°ì™€ ë™ì¼í•œì§€ ë¹„êµí•´ ë³´ë©´ ì•„ë˜ ì˜ˆì™€ ê°™ì´ ë™ì¼í•¨ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
   ```sh
   $ md5sum test.*
   3d5b2e1460744619ccc97983ff740375  test.bin
   3d5b2e1460744619ccc97983ff740375  test.read.bin
   ```
   `nanddump`ëŠ” ì•„ë˜ ì˜ˆì™€ ê°™ì´ **-o** ì˜µì…˜ì„ ì£¼ë©´ OOB ë°ì´í„°ë„ ë¤í”„ëœ° ìˆ˜ ìˆë‹¤. (**OOB Data** ì˜ì—­ì— OOB ë°ì´í„°ê°€ í‘œì‹œë¨)
   ```sh
    $ sudo nanddump -o -p /dev/mtd0 -l 1310720 > mtd_dump.txt
   ```
1. ì•„ë˜ì™€ ê°™ì´ `nandtest` íˆ´ë¡œ í…ŒìŠ¤íŠ¸ë„ ê°€ëŠ¥í•˜ë‹¤. (**-k** ì˜µì…˜ì„ ì£¼ë©´ í…ŒìŠ¤íŠ¸ í›„ì— ì›ë³¸ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë³µêµ¬í•¨)
   ```sh
   $ sudo nandtest -k /dev/mtd0
   ```

## NAND ë””ë°”ì´ìŠ¤ íŒŒí‹°ì…˜, bad block ìƒì„±
1. MTD íŒŒí‹°ì…˜ ìƒì„±ì€ ì•„ë˜ ì˜ˆì™€ ê°™ì´ `parts` ì˜µì…˜ìœ¼ë¡œ block ê°œìˆ˜ë¥¼ ì£¼ë©´ ëœë‹¤.
   ```sh
   $ sudo modprobe nandsim id_bytes=0x1,0xA1,0x0,0x15 parts=24,256,296
   ```
   ì•„ë˜ì™€ ê°™ì´ í™•ì¸í•´ ë³´ë©´, ê¸°ëŒ€ëŒ€ë¡œ 4ê°œì˜ íŒŒí‹°ì…˜ì´ ê°ê° 24 block, 256 block, 296 block, 448 blockì˜ í¬ê¸°ë¡œ ìƒì„±ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. (ë§ˆì§€ë§‰ block ìˆ˜ = ì „ì²´ block ìˆ˜ - ì‚¬ìš©ëœ block ìˆ˜ = 1024 - 24 - 256 - 296 = 448)
   ```sh
   $ cat /proc/mtd
   dev:    size   erasesize  name
   mtd0: 00300000 00020000 "NAND simulator partition 0"
   mtd1: 02000000 00020000 "NAND simulator partition 1"
   mtd2: 02500000 00020000 "NAND simulator partition 2"
   mtd3: 03800000 00020000 "NAND simulator partition 3"
   $ mtdinfo /dev/mtd0
   mtd0
   Name:                           NAND simulator partition 0
   Type:                           nand
   Eraseblock size:                131072 bytes, 128.0 KiB
   Amount of eraseblocks:          24 (3145728 bytes, 3.0 MiB)
   Minimum input/output unit size: 2048 bytes
   Sub-page size:                  512 bytes
   OOB size:                       64 bytes
   Character device major/minor:   90:0
   Bad blocks are allowed:         true
   Device is writable:             true
   $ mtdinfo /dev/mtd1
   mtd1
   Name:                           NAND simulator partition 1
   Type:                           nand
   Eraseblock size:                131072 bytes, 128.0 KiB
   Amount of eraseblocks:          256 (33554432 bytes, 32.0 MiB)
   Minimum input/output unit size: 2048 bytes
   Sub-page size:                  512 bytes
   OOB size:                       64 bytes
   Character device major/minor:   90:2
   Bad blocks are allowed:         true
   Device is writable:             true
   $ mtdinfo /dev/mtd2
   mtd2
   Name:                           NAND simulator partition 2
   Type:                           nand
   Eraseblock size:                131072 bytes, 128.0 KiB
   Amount of eraseblocks:          296 (38797312 bytes, 37.0 MiB)
   Minimum input/output unit size: 2048 bytes
   Sub-page size:                  512 bytes
   OOB size:                       64 bytes
   Character device major/minor:   90:4
   Bad blocks are allowed:         true
   Device is writable:             true
   $ mtdinfo /dev/mtd3
   mtd3
   Name:                           NAND simulator partition 3
   Type:                           nand
   Eraseblock size:                131072 bytes, 128.0 KiB
   Amount of eraseblocks:          448 (58720256 bytes, 56.0 MiB)
   Minimum input/output unit size: 2048 bytes
   Sub-page size:                  512 bytes
   OOB size:                       64 bytes
   Character device major/minor:   90:6
   Bad blocks are allowed:         true
   Device is writable:             true
   ```
1. Bad block ìƒì„±ì€ ì•„ë˜ ì˜ˆì™€ ê°™ì´ `badblocks` ì˜µì…˜ìœ¼ë¡œ bad block ê°’ì„ ì£¼ë©´ ëœë‹¤. (ì•„ë˜ ì˜ˆì—ì„œëŠ” 0, 10, 100, 310, 410 blockì„ bad blockìœ¼ë¡œ ì§€ì •í•˜ì˜€ìŒ)
   ```sh
   $ sudo modprobe nandsim id_bytes=0x1,0xA1,0x0,0x15 parts=24,256,296 badblocks=0,10,100,310,410
   ```
   íŒŒí‹°ì…˜ì„ í™•ì¸í•´ ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ ë‚˜ì˜¨ë‹¤.
   ```sh
   $ cat /proc/mtd
   dev:    size   erasesize  name
   mtd0: 00300000 00020000 "NAND simulator partition 0"
   mtd1: 02000000 00020000 "NAND simulator partition 1"
   mtd2: 02500000 00020000 "NAND simulator partition 2"
   mtd3: 03800000 00020000 "NAND simulator partition 3"
   ```
   ê° MTD íŒŒí‹°ì…˜ì˜ bad blockì„ í™•ì¸í•´ ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ ê¸°ëŒ€ëŒ€ë¡œ ë‚˜ì˜¨ë‹¤.
   ```sh
   $ cat /sys/class/mtd/mtd0/bad_blocks
   2
   $ cat /sys/class/mtd/mtd1/bad_blocks
   1
   $ cat /sys/class/mtd/mtd2/bad_blocks
   2
   $ cat /sys/class/mtd/mtd3/bad_blocks
   0
   ```
   ë˜ `nandtest` íˆ´ë¡œ í…ŒìŠ¤íŠ¸í•´ ë³´ë©´, ì•„ë˜ì™€ ê°™ì´ ì§€ì •ëœ blockì´ bad blockì´ ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 
   ```sh
   $ sudo nandtest -k /dev/mtd0
   ECC corrections: 0
   ECC failures   : 0
   Bad blocks     : 2
   BBT blocks     : 0
   Bad block at 0x00000000 1)...
   Bad block at 0x00140000 1)...
   002e0000: checking...of 1)...
   Finished pass 1 successfully
   $ sudo nandtest -k /dev/mtd1
   ECC corrections: 0
   ECC failures   : 0
   Bad blocks     : 1
   BBT blocks     : 0
   Bad block at 0x00980000 1)...
   01fe0000: checking...of 1)...
   Finished pass 1 successfully
   $ sudo nandtest -k /dev/mtd2
   ECC corrections: 0
   ECC failures   : 0
   Bad blocks     : 2
   BBT blocks     : 0
   Bad block at 0x003c0000 1)...
   Bad block at 0x01040000 1)...
   024e0000: checking...of 1)...
   Finished pass 1 successfully
   ```
   ë˜, `mtdinfo` íˆ´ë¡œ **-M** ì˜µì…˜ì„ ì£¼ë©´, bad blockì€ **BAD**ë¡œ í‘œì‹œê°€ ëœë‹¤. (ì•„ë˜ ì˜ˆì—ì„œëŠ” ì„¸íŒ…í•œëŒ€ë¡œ **0**ë²ˆ, **10**ë²ˆ blockì´ BADë¡œ í‘œì‹œë˜ì—ˆìŒ)
   ```sh
   $ sudo mtdinfo /dev/mtd0 -M
   mtd0
   Name:                           NAND simulator partition 0
   Type:                           nand
   Eraseblock size:                131072 bytes, 128.0 KiB
   Amount of eraseblocks:          24 (3145728 bytes, 3.0 MiB)
   Minimum input/output unit size: 2048 bytes
   Sub-page size:                  512 bytes
   OOB size:                       64 bytes
   Character device major/minor:   90:0
   Bad blocks are allowed:         true
   Device is writable:             true
   Eraseblock map:
     0: 00000000    BAD   1: 00020000          2: 00040000          3: 00060000
     4: 00080000          5: 000a0000          6: 000c0000          7: 000e0000
     8: 00100000          9: 00120000         10: 00140000    BAD  11: 00160000
    12: 00180000         13: 001a0000         14: 001c0000         15: 001e0000
    16: 00200000         17: 00220000         18: 00240000         19: 00260000
    20: 00280000         21: 002a0000         22: 002c0000         23: 002e0000
   $ sudo mtdinfo /dev/mtd0 -M
   mtd0
   Name:                           NAND simulator partition 0
   Type:                           nand
   Eraseblock size:                131072 bytes, 128.0 KiB
   Amount of eraseblocks:          24 (3145728 bytes, 3.0 MiB)
   Minimum input/output unit size: 2048 bytes
   Sub-page size:                  512 bytes
   OOB size:                       64 bytes
   Character device major/minor:   90:0
   Bad blocks are allowed:         true
   Device is writable:             true
   Eraseblock map:
     0: 00000000    BAD   1: 00020000          2: 00040000          3: 00060000
     4: 00080000          5: 000a0000          6: 000c0000          7: 000e0000
     8: 00100000          9: 00120000         10: 00140000    BAD  11: 00160000
    12: 00180000         13: 001a0000         14: 001c0000         15: 001e0000
    16: 00200000         17: 00220000         18: 00240000         19: 00260000
    20: 00280000         21: 002a0000         22: 002c0000         23: 002e0000
   ``` 
   ë˜, ì•„ë˜ì™€ ê°™ì´ `nanddump` íˆ´ë¡œ í™•ì¸í•´ ë³´ë©´, í•´ë‹¹ bad blockì€ skip ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
   ```sh
   $ sudo nanddump -o -p /dev/mtd0 > mtd_dump.txt
   ```
   ë§Œì•½ bad blockë„ dump ëœ¨ê³  ì‹¶ìœ¼ë©´, ì•„ë˜ ì˜ˆì™€ ê°™ì´ `--bb=dumpbad` ì˜µì…˜ì„ ì¶”ê°€í•˜ë©´ ëœë‹¤.
   ```sh
   $ sudo nanddump -o -p --bb=dumpbad /dev/mtd0 > mtd_dump.txt
   ```
   Bad blockì˜ ì²«ë²ˆì§¸ì™€ ë§ˆì§€ë§‰ pageì—ì„œ OOB ë°ì´í„°ì˜ ì²« ë°”ì´íŠ¸ ê°’ì´ **0xFF**ê°€ ì•„ë‹Œ **0x00**ìœ¼ë¡œ bad block ë§ˆí‚¹ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

## NAND ë””ë°”ì´ìŠ¤ ì œê±°
í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ì—,Â simulated NAND deviceë¥¼ ì œê±°í•˜ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ì™€ ê°™ì´ í•˜ë©´ ëœë‹¤.
```sh
$ sudo rmmod nandsim
```
ì´í›„ `cat /proc/mtd` ëª…ë ¹ìœ¼ë¡œ í™•ì¸í•´ë³´ë©´ simulated MTD ë””ë°”ì´ìŠ¤ê°€ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

## UBIFS ì´ë¯¸ì§€ í™•ì¸
1. ì•„ë˜ ì˜ˆì™€ ê°™ì´ nandsimìœ¼ë¡œ simulated NAND deviceë¥¼ ìƒì„±í•œë‹¤. (í¸ì˜ìƒ íŒŒí‹°ì…˜ 1ê°œë§Œ ìƒì„±)
   ```sh
   $ sudo modprobe nandsim id_bytes=0x20,0xaa,0x00,0x15
   ```
   ì•„ë˜ì™€ ê°™ì´ í™•ì¸í•´ë³´ë©´ 256MiB NAND ë””ë°”ì´ìŠ¤ê°€ ìƒì„±ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
   ```sh
   $ cat /proc/mtd
   dev:Â  Â  sizeÂ  Â erasesizeÂ  name
   mtd0: 10000000 00020000 "NAND simulator partition 0"
   ```
1. ì•„ë˜ì™€ ê°™ì´ MTD ì˜ì—­ì„ erase í•œë‹¤.
   ```sh
   $ sudo flash_erase /dev/mtd0 0 0
   ```
1. ì•„ë˜ì™€ ê°™ì´ UBI ëª¨ë“ˆì„ insert ì‹œí‚¨ë‹¤. (Kernel configì—ì„œ `CONFIG_MTD_UBI`, `CONFIG_UBIFS_FS` í•­ëª©ì´ enableë˜ì–´ ìˆì–´ì•¼ í•¨)
   ```sh
   $ sudo modprobe ubi mtd=0
   ```
1. ì•„ë˜ì™€ ê°™ì´ UBI detach, format, attach ì‹œí‚¨ë‹¤. (ì˜ˆë¡œ MTD0 ì‚¬ìš©)
   ```sh
   $ sudo ubidetach /dev/ubi_ctrl -m 0
   $ sudo ubiformat /dev/mtd0
   $ sudo ubiattach /dev/ubi_ctrl -m 0
   ```
1. ì•„ë˜ ì˜ˆì™€ ê°™ì´ UBI ë³¼ë¥¨ì„ ìƒì„±í•œë‹¤. (ì˜ˆë¡œ ì´ë¦„ì„ "rootfs", í¬ê¸°ë¥¼ 128MiBë¡œ í•˜ì˜€ìŒ)
   ```sh
   $ sudo ubimkvol /dev/ubi0 -N rootfs -s 128MiB
   ```
1. ì•„ë˜ ì˜ˆì™€ ê°™ì´ í™•ì¸í•  UBIFS ì´ë¯¸ì§€ë¥¼ ë³¼ë¥¨ì— ì ìš©í•œë‹¤.
   ```sh
   $ sudo ubiupdatevol /dev/ubi0_0 rootfs.ubifs
   ```
1. ì´ì œ ì•„ë˜ ì˜ˆì™€ ê°™ì´ ë§ˆìš´íŠ¸ì‹œí‚¬ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•œ í›„, ë§ˆìš´íŠ¸ ì‹œí‚¤ê³  ë””ë ‰í† ë¦¬ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
   ```sh
   $ mkdir ubimount
   $ sudo mount -t ubifs ubi0:rootfs ubimount/
   $ ls -l ubimount/
   ```
1. ì•„ë˜ì™€ ê°™ì´ UBI unmount ë° simulated NAND ë””ë°”ì´ìŠ¤ë¥¼ ì œê±°í•  ìˆ˜ ìˆë‹¤.
   ```sh
   $ sudo umount ubimount/
   $ sudo rmmod nandsim
   ```
1. ì°¸ê³ ë¡œ UBIFS ì´ë¯¸ì§€ê°€ ì•„ë‹Œ **UBI** ì´ë¯¸ì§€ëŠ” ì•„ë˜ì™€ ê°™ì´ ë°”ë¡œ write í•œ í›„, ë§ˆìš´íŠ¸í•˜ë©´ ëœë‹¤.
   ```sh
   $ sudo modprobe nandsim id_bytes=0x20,0xaa,0x00,0x15
   $ sudo nandwrite /dev/mtd0 rootfs_image.ubi
   $ sudo modprobe ubi mtd=/dev/mtd0,4096
   $ sudo mount -t ubifs /dev/ubi0_0 ubimount/
   $ ls -l ubimount/
   $ sudo umount ubimount/
   $ sudo rmmod nandsim
   ```

## SQUASHFS í…ŒìŠ¤íŠ¸
1. í…ŒìŠ¤íŠ¸ í•  squashfs ì´ë¯¸ì§€ íŒŒì¼ì„ ì¤€ë¹„í•œë‹¤. ì•„ë˜ì™€ ê°™ì´ í™•ì¸í•´ ë³¼ ìˆ˜ ìˆë‹¤.
   ```sh
   $ sudo mount -o loop -t squashfs rootfs.squashfs /mnt/
   $ sudo umount /mnt
   ```
1. ì•„ë˜ì™€ ê°™ì´ íŒŒí‹°ì…˜ì„ erase í•œë‹¤. (ì˜ˆë¡œ MTD17 ì‚¬ìš©)
   ```sh
   $ sudo flash_erase /dev/mtd17 0 0
   Erasing 128 Kibyte @ 100000 --  1 % complete flash_erase: Skipping bad block at 00120000
   Erasing 128 Kibyte @ 240000 --  2 % complete flash_erase: Skipping bad block at 00260000
   Erasing 128 Kibyte @ 5e60000 -- 100 % complete
   ```
1. ì•„ë˜ì™€ ê°™ì´ squashfs ì´ë¯¸ì§€ë¥¼ write í•œë‹¤.
   ```sh
   $ sudo nandwrite -p /dev/mtd17 rootfs.squashfs
   ```
   ì•„ë˜ì™€ ê°™ì´ dd dump ë¹„êµí•´ ë³¼ ìˆ˜ ìˆë‹¤.
   ```sh
   $ sudo dd if=/dev/mtd17 of=mtd17_dd_dump.bin bs=1MiB count=14
   ```
   ê²°ê³¼ë¡œ rootfs.squashfs íŒŒì¼ê³¼ mtd17_dd_dump.binì„ ë¹„êµí•´ë³´ë©´ bad blockì´ ìˆì–´ì„œ ë‹¤ë¥´ë‹¤.
   ì•„ë˜ì™€ ê°™ì´ nanddumpë¡œ ë¹„êµí•´ ë³¼ ìˆ˜ ìˆë‹¤.
   ```sh
   $ sudo nanddump /dev/mtd17 -f mtd17_nand_dump.bin -l 0xE00000
   ```
   ê²°ê³¼ë¡œ rootfs.squashfs íŒŒì¼ê³¼ mtd17_nand_dump.binì„ ë¹„êµí•´ë³´ë©´ ë™ì¼í•˜ë‹¤.

## SQUASHFS on top of UBI í…ŒìŠ¤íŠ¸
1. ì•„ë˜ì™€ ê°™ì´ `ubinize.cfg` íŒŒì¼ì„ ì‘ì„±í•œë‹¤. (ì…ë ¥ íŒŒì¼ì€ image ì•„ê·œë¨¼íŠ¸ë¡œ ì§€ì •í•œ rootfs.squashfs íŒŒì¼ì´ ë¨)
   ```ini
   [squashfs]
   mode=ubi
   image=rootfs.squashfs
   vol_id=0
   vol_size=28MiB
   vol_type=dynamic
   vol_name=squashfs
   vol_flags=autoresize
   ```
1. ì•„ë˜ì™€ ê°™ì´ ubinizeë¥¼ ì‹¤í–‰ì‹œí‚¨ë‹¤.
   ```sh
   $ ubinize -o ubi-rootfs.squashfs -m 2048 -p 128KiB -s 512 -O 2048 ubinize.cfg
   ```
   ê²°ê³¼ë¡œ ubi-rootfs.squashfs ì´ë¦„ì˜ UBI ì´ë¯¸ì§€ê°€ ìƒì„±ëœë‹¤.
1. ì•„ë˜ì™€ ê°™ì´ MTDì— write í•œë‹¤.
   ```sh
   $ sudo flash_erase /dev/mtd17 0 0
   Erasing 128 Kibyte @ 100000 --  1 % complete flash_erase: Skipping bad block at 00120000
   Erasing 128 Kibyte @ 240000 --  2 % complete flash_erase: Skipping bad block at 00260000
   Erasing 128 Kibyte @ 5e60000 -- 100 % complete
   $ sudo nandwrite -p /dev/mtd17 ubi-rootfs.squashfs
   ```
1. ì´ íŒŒí‹°ì…˜ì„ rootfsë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•˜ì—¬ ì•„ë˜ì™€ ê°™ì´ ubi block device driverë¥¼ ë¡œë”©í•œë‹¤.
   ```sh
   $ sudo modprobe ubi mtd=17,2048 block=0,0
   $ sudo ls /dev/ubi*
   /dev/ubi0  /dev/ubi0_0  /dev/ubiblock0_0  /dev/ubi_ctrl
   ```
   ì´ì œ ì•„ë˜ì™€ ê°™ì´ ë§ˆìš´íŠ¸ì‹œí‚¨ë‹¤.
   ```sh
   $ sudo mount -t squashfs -r /dev/ubiblock0_0 /mnt
   ```
   ì•„ë˜ì™€ ê°™ì´ í™•ì¸í•´ ë³´ë©´ rootfs íŒŒì¼ë“¤ì´ ì •ìƒì ìœ¼ë¡œ ë³´ì¸ë‹¤.
   ```sh
   $ ls -l /mnt/
   ```
1. nanddump íˆ´ë¡œ /dev/mtd17ì„ ë¤í”„ ëœ¨ë©´ UBI ì´ë¯¸ì§€ê°€ ì½íŒë‹¤. squashfs ì´ë¯¸ì§€ë¥¼ ì½ìœ¼ë ¤ë©´ ì•„ë˜ì™€ ê°™ì´ í•˜ë©´ ëœë‹¤.
   ```sh
   $ sudo dd if=/dev/ubiblock0_0 of=mtd17_squash_dump.bin bs=1MiB count=14 
   ```
1. í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ì„œ simulated NAND deviceë¥¼ ì œê±°í•˜ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ì™€ ê°™ì´ í•˜ë©´ ëœë‹¤.
   ```
   $ sudo rmmod nandsim
   ```
