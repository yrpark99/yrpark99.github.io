---
title: "Windows11 WSL2 소개"
category: Linux
toc: true
toc_label: "이 페이지 목차"
---

Windows11에 포함된 WSL2를 간단히 소개한다.

## Windows11 설치
2021년 10월 5일에 Windows11이 출시되었다.  
Windows10에서 무료로 업그레이드할 수 있으므로 집에 있는 데스크탑과 노트북에서 각각 업그레이드와 클린 설치를 해 보았다. BIOS에서 TPM과 secure boot만 enable 시키니, 둘 다 어려움없이 금방 설치가 완료되었다.

## Windows11 기본 포함
Windows11에는 Windows terminal이 기본으로 포함되어 있다.
> Windows11에서는 탐색기에서 마우스 우클릭하여 `Windows 터미널에서 열기`를 선택하면 바로 해당 디렉토리에서 Windows terminal이 열리므로 한층 편리해졌다.

그런데 앱 패키지 관리자로 많이 쓰이는 `winget`은 여전히 디폴트로 포함되어 있지는 않아서, Microsoft 스토어를 통하여 설치해야 한다.

## WSL 설치
Microsoft 스토어에서 설치하려는 WSL 배포판을 검색하여 설치하면 된다.  
참고로 Windows11에 포함된 WSL은 새로 추가된 `--install` 옵션을 지원한다. 관리자 권한의 consle에서 이 옵션을 사용하여 실행시키면, WSL에 필요한 모든 컴포넌트들이 자동으로 설치된다. (정말 편해졌다. 😊)
```shell
C:\>wsl --install
```
결과로 아래 출력과 같이 모든 작업이 자동으로 완료된다.
```shell
설치 중: 가상 머신 플랫폼
가상 머신 플랫폼이(가) 설치되었습니다.
설치 중: Linux용 Windows 하위 시스템
Linux용 Windows 하위 시스템이(가) 설치되었습니다.
다운로드 중: WSL 커널
설치 중: WSL 커널
WSL 커널이(가) 설치되었습니다.
다운로드 중: GUI 앱 지원
설치 중: GUI 앱 지원
GUI 앱 지원이(가) 설치되었습니다.
다운로드 중: Ubuntu
요청한 작업이 잘 실행되었습니다. 시스템을 다시 시작하면 변경 사항이 적용됩니다.
```

## WSL 업데이트
Windows11에 포함된 WSL은 새로 추가된 `--update` 옵션을 사용하여 WSL을 업데이트시킬 수 있다. 관리자 권한의 consle에서 아래와 같이 실행하면 WSL이 업데이트된다.
```shell
C:\>wsl --update
```
또한 새로 추가된 `--version` 옵션을 사용하여 아래와 같이 설치된 WSL의 버전도 확인할 수 있다.
```shell
C:\>wsl --version
```

## WSL Linux 배포판 설치
아래와 같이 실행하면 사용 가능한 모든 배포판 정보가 출력된다.
```shell
C:\>wsl --list --online
```
현재 시점에서는 결과로 아래와 같이 나왔다.
```
다음은 설치할 수 있는 유효한 배포 목록입니다.
'wsl --install -d <배포>'를 사용하여 설치하세요.

NAME            FRIENDLY NAME
Ubuntu          Ubuntu
Debian          Debian GNU/Linux
kali-linux      Kali Linux Rolling
openSUSE-42     openSUSE Leap 42
SLES-12         SUSE Linux Enterprise Server v12
Ubuntu-16.04    Ubuntu 16.04 LTS
Ubuntu-18.04    Ubuntu 18.04 LTS
Ubuntu-20.04    Ubuntu 20.04 LTS
```
아래와 같이 해당 Linux 배포판을 설치할 수 있다.
```shell
C:\>wsl --install --distribution <배포판이름>
```
또는 Microsoft Store에서 Linux로 검색해서 나오는 배포판을 선택하여 설치할 수 있다.

## WSL Linux 배포판 상태
현재 설치된 Linux 배포판 상태는 아래와 같이 얻을 수 있다.
```shell
C:\>wsl -l -v
```

## WSL Linux 실행
Linux 배포판은 아래와 같이 실행시킬 수 있다.
```shell
C:\>wsl -d <배포판이름>
```
만약 배포판이 1개만 설치되어 있는 상태이면 아래와 같이 간단히 실행시킬 수 있다.
```shell
C:\>wsl
```
추가로 시작시 자동으로 특정 디렉토리로 옮기려면 아래와 같이 `--cd` 옵션으로 지정하면 된다. (예를 들어, home 디렉토리로 지정하고 싶으면 `~`로 지정하면 됨)
```
C:\>wsl --cd <Directory>
```

## WSL 드라이브
Windows11에서는 디폴트로 탐색기에 설치된 WSL 배포판의 드라이브가 아래 예와 같이 표시되므로 탐색기에서도 WSL 디렉토리에 쉽게 접근할 수 있다.
<p><img src="/assets/images/linux_drive.png"></p>

## WSL GUI
Windows11의 WSL에서는 디폴트로 Linux GUI 앱을 지원한다. 단순히 WSL을 실행한 후, GUI 프로그램을 설치해서 실행하기만 하면 된다. GUI 실행 속도도 빠르다. 😍

## Windows PATH 제거하기
WSL은 디폴트로 Linux PATH에 Windows PATH 경로를 추가한다. 이는 탐색기(explorer.exe), VSCode(code.exe) 등과 같이 Windows 프로그램을 경로에 추가시켜서 전체 경로없이도 실행시켜 주기 위한 것인데, 간혹 이것 때문에 Linux에서 문제가 발생하는 경우도 있다. (예를 들어 PATH에서 `Program Files`와 같은 경로는 중간에 공백 문자가 들어가는데, 이 경우에는 양쪽을 `""`로 감싸줘야하는데 이게 없어서임)  
이에 대한 간단한 해결책으로 Windows PATH를 포함시키지 않게 하면 된다. 이를 위해서 WSL에서 `/etc/wsl.conf` 파일을 아래와 같이 작성하면 된다.
```ini
[interop]
appendWindowsPath = false
```
이제 아래와 같이 배포판을 shutdown 시킨다.
```shell
C:\>wsl --shutdown
```
이후 WSL을 다시 시작시켜서 PATH를 확인해 보면 Windows PATH는 추가되지 않았음을 확인할 수 있다.  
<br>
그런데 이 경우에는 Windows PATH 전체가 추가되지 않았으므로, 탐색기나 VSCode 등을 실행하기 위해서는 전체 경로로 실행시켜야 하므로 불편하다. 그래서 나는 주로 ~/.bashrc 파일에서 아래 예와 같이 alias와 PATH를 추가하여 사용한다.
```shell
alias code='/mnt/c/Program\ Files/Microsoft\ VS\ Code/bin/code'
export PATH=$PATH:"/mnt/c/Windows"
```

## snap 패키지 설치시 에러
그런데 snap으로 패키지 설치시에 아래와 같은 에러가 발생하면서 설치가 되는 않는 경우가 있었다.
> error: cannot communicate with server: Post http://localhost/v2/snaps/code: dial unix /run/snapd.socket: connect: no such file or directory

구글링 한 결과, https://github.com/microsoft/WSL/issues/5126 내용을 참고하여 아래와 같이 실행한 후에, 다시 시도해 보니 패키지가 잘 설치되었다.
```shell
$ sudo apt update
$ sudo apt install -yqq daemonize dbus-user-session fontconfig
$ sudo daemonize /usr/bin/unshare --fork --pid --mount-proc /lib/systemd/systemd --system-unit=basic.target
$ exec sudo nsenter -t $(pidof systemd) -a su - $LOGNAME
```

## WSL 배포판 크기 줄이기
WSL 배포판에서 파일들을 삭제해도 사용하는 가상 드라이브(VHD)의 크기는 줄어들지 않고 커지기만 한다. 따라서 필요시 아래와 같이 수동으로 크기를 줄어줘야 한다.
1. 실행 중인 WSL 인스턴스를 종료시킨다.
```shell
C:\>wsl --shutdown
```
1. 대상 배포판 VHD의 전체 경로를 찾는다. 탐색기에서 `%localappdata%\Packages\` 경로에 들어가서 해당 VHD 파일을 찾으면 된다. (*.vhd로 검색하면 나옴, 나 같은 경우에는 이 디렉토리 밑에 CanonicalGroupLimited.Ubuntu18.04onWindows_79rhkp1fndgsc\LocalState\ext4.vhdx 파일이 있었음)
1. 커맨드 창에서 `diskpart` 명령을 실행하면 별도의 콘솔 창이 뜨는데, 여기에서 아래와 같이 실행하면 된다.
```shell
DISKPART> select vdisk file="타겟 VHD 파일의 전체 경로"
DISKPART> compact vdisk
DISKPART> exit
```
